# λ°μ΄ν„°λ² μ΄μ¤ μ¤ν‚¤λ§

μ΄ ν΄λ”μ—λ” 3vs3 λ°°κµ¬ κ²μ„μ Supabase λ°μ΄ν„°λ² μ΄μ¤ μ¤ν‚¤λ§κ°€ ν¬ν•¨λμ–΄ μμµλ‹λ‹¤.

## νμΌ μ„¤λ…

### 1. `schema.sql`
κΈ°λ³Έ λ°μ΄ν„°λ² μ΄μ¤ ν…μ΄λΈ”κ³Ό μΈλ±μ¤λ¥Ό μƒμ„±ν•©λ‹λ‹¤.

**ν…μ΄λΈ”:**
- **profiles**: μ‚¬μ©μ ν”„λ΅ν•„ μ •λ³΄
- **characters**: μΊλ¦­ν„° μ»¤μ¤ν„°λ§μ΄μ§• λ°μ΄ν„°
- **game_history**: κ²μ„ κ²°κ³Ό κΈ°λ΅
- **player_stats**: ν”λ μ΄μ–΄ ν†µκ³„ λ° λ­ν‚Ή

**Row Level Security (RLS):**
- λ¨λ“  ν…μ΄λΈ”μ— RLS ν™μ„±ν™”
- μ½κΈ°λ” κ³µκ°, μ“°κΈ°λ” λ³ΈμΈλ§ κ°€λ¥

### 2. `triggers.sql`
μλ™ν™”λ¥Ό μ„ν• νΈλ¦¬κ±°μ™€ ν•¨μλ¥Ό μƒμ„±ν•©λ‹λ‹¤.

**μ£Όμ” κΈ°λ¥:**
- **μλ™ ν”„λ΅ν•„ μƒμ„±**: μ‹ κ· μ‚¬μ©μ κ°€μ… μ‹ μλ™μΌλ΅ ν”„λ΅ν•„, ν†µκ³„, κΈ°λ³Έ μΊλ¦­ν„° μƒμ„±
- **updated_at μλ™ κ°±μ‹ **: λ μ½”λ“ μ—…λ°μ΄νΈ μ‹ μλ™μΌλ΅ νƒ€μ„μ¤νƒ¬ν”„ κ°±μ‹ 
- **ν‹°μ–΄ μλ™ μ—…λ°μ΄νΈ**: λ μ΄ν… λ³€κ²½ μ‹ μλ™μΌλ΅ ν‹°μ–΄ κ³„μ‚°

**ν‹°μ–΄ μ‹μ¤ν…:**
- Bronze: 0-1199 λ μ΄ν…
- Silver: 1200-1499 λ μ΄ν…
- Gold: 1500-1999 λ μ΄ν…
- Diamond: 2000+ λ μ΄ν…

### 3. `functions.sql`
κ²μ„ λ΅μ§κ³Ό λ°μ΄ν„° μ΅°νλ¥Ό μ„ν• ν•¨μλ“¤μ…λ‹λ‹¤.

**ν•¨μ λ©λ΅:**

#### `record_game_result()`
κ²μ„ μΆ…λ£ ν›„ κ²°κ³Όλ¥Ό κΈ°λ΅ν•κ³  ν”λ μ΄μ–΄ ν†µκ³„λ¥Ό μ—…λ°μ΄νΈν•©λ‹λ‹¤.

**νλΌλ―Έν„°:**
- `p_room_id`: κ²μ„ λ£Έ ID
- `p_winner_team`: μΉλ¦¬ ν€ ('A' λλ” 'B')
- `p_team_a_players`: ν€ A ν”λ μ΄μ–΄ UUID λ°°μ—΄
- `p_team_b_players`: ν€ B ν”λ μ΄μ–΄ UUID λ°°μ—΄
- `p_final_score_a`: ν€ A μµμΆ… μ μ
- `p_final_score_b`: ν€ B μµμΆ… μ μ
- `p_duration`: κ²μ„ μ‹κ°„ (μ΄)

**λ°ν™κ°’:** μƒμ„±λ κ²μ„ κΈ°λ΅ ID

**μ‚¬μ© μμ‹:**
```sql
SELECT record_game_result(
  'room_123',
  'A',
  ARRAY['uuid1', 'uuid2', 'uuid3']::uuid[],
  ARRAY['uuid4', 'uuid5', 'uuid6']::uuid[],
  25,
  20,
  600
);
```

#### `get_leaderboard()`
λ μ΄ν… κΈ°μ¤€ λ¦¬λ”λ³΄λ“λ¥Ό μ΅°νν•©λ‹λ‹¤.

**νλΌλ―Έν„°:**
- `p_limit`: μ΅°νν•  ν”λ μ΄μ–΄ μ (κΈ°λ³Έκ°’: 100)
- `p_tier`: νΉμ • ν‹°μ–΄ ν•„ν„° (μ„ νƒμ‚¬ν•­)

**μ‚¬μ© μμ‹:**
```sql
-- μ „μ²΄ λ¦¬λ”λ³΄λ“ μƒμ„ 100λ…
SELECT * FROM get_leaderboard();

-- κ³¨λ“ ν‹°μ–΄ μƒμ„ 50λ…
SELECT * FROM get_leaderboard(50, 'gold');
```

#### `get_player_history()`
νΉμ • ν”λ μ΄μ–΄μ κ²μ„ μ „μ μ„ μ΅°νν•©λ‹λ‹¤.

**νλΌλ―Έν„°:**
- `p_user_id`: ν”λ μ΄μ–΄ UUID
- `p_limit`: μ΅°νν•  κ²μ„ μ (κΈ°λ³Έκ°’: 20)

**μ‚¬μ© μμ‹:**
```sql
SELECT * FROM get_player_history('user-uuid-here', 10);
```

#### `set_active_character()`
ν”λ μ΄μ–΄μ ν™μ„± μΊλ¦­ν„°λ¥Ό λ³€κ²½ν•©λ‹λ‹¤.

**νλΌλ―Έν„°:**
- `p_user_id`: ν”λ μ΄μ–΄ UUID
- `p_character_id`: ν™μ„±ν™”ν•  μΊλ¦­ν„° UUID

**μ‚¬μ© μμ‹:**
```sql
SELECT set_active_character('user-uuid', 'character-uuid');
```

#### `check_username_available()`
μ‚¬μ©μλ… μ‚¬μ© κ°€λ¥ μ—¬λ¶€λ¥Ό ν™•μΈν•©λ‹λ‹¤.

**νλΌλ―Έν„°:**
- `p_username`: ν™•μΈν•  μ‚¬μ©μλ…

**λ°ν™κ°’:** boolean (true = μ‚¬μ© κ°€λ¥, false = μ¤‘λ³µ)

**μ‚¬μ© μμ‹:**
```sql
SELECT check_username_available('newuser123');
```

## μ„¤μΉ μμ„

Supabase SQL Editorμ—μ„ λ‹¤μ μμ„λ΅ μ‹¤ν–‰ν•μ„Έμ”:

1. **schema.sql** - ν…μ΄λΈ” λ° μΈλ±μ¤ μƒμ„±
2. **triggers.sql** - νΈλ¦¬κ±° λ° μλ™ν™” μ„¤μ •
3. **functions.sql** - λΉ„μ¦λ‹μ¤ λ΅μ§ ν•¨μ μƒμ„±

## λ°μ΄ν„° λ¨λΈ

```
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ auth.users  β”‚ (Supabase Auth)
β””β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”
       β”‚
       β”‚ 1:1
       β–Ό
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”      1:N      β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚  profiles   β”‚β—„β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”‚  characters  β”‚
β””β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”               β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
       β”‚
       β”‚ 1:1
       β–Ό
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ player_stats β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”

β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ game_history β”‚ (ν”λ μ΄μ–΄ UUID λ°°μ—΄ μ°Έμ΅°)
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
```

## μ£Όμμ‚¬ν•­

1. **Service Role Key**: μ„λ²„μ—μ„ `record_game_result()` νΈμ¶ μ‹ service role key μ‚¬μ© ν•„μ”
2. **RLS μ •μ±…**: ν΄λΌμ΄μ–ΈνΈμ—μ„ μ§μ ‘ ν†µκ³„λ¥Ό μμ •ν•  μ μ—†λ„λ΅ μ„¤μ •λ¨
3. **μλ™ ν”„λ΅ν•„ μƒμ„±**: Google λ΅κ·ΈμΈ μ‹ μλ™μΌλ΅ ν”„λ΅ν•„μ΄ μƒμ„±λ¨
4. **λ μ΄ν… μ‹μ¤ν…**: κΈ°λ³Έ λ μ΄ν… 1000, μΉλ¦¬ μ‹ +25, ν¨λ°° μ‹ -25

## λ¬Έμ  ν•΄κ²°

### νΈλ¦¬κ±°κ°€ μ‹¤ν–‰λμ§€ μ•μ•„μ”
- auth.users ν…μ΄λΈ”μ— λ€ν• κ¶ν• ν™•μΈ
- νΈλ¦¬κ±°κ°€ μ¬λ°”λ¥΄κ² μƒμ„±λμ—λ”μ§€ ν™•μΈ:
  ```sql
  SELECT * FROM pg_trigger WHERE tgname = 'on_auth_user_created';
  ```

### ν•¨μ μ‹¤ν–‰ μ‹ κ¶ν• μ—λ¬
- ν•¨μλ” `SECURITY DEFINER`λ΅ μ„¤μ •λμ–΄ μμ–΄μ•Ό ν•¨
- μ„λ²„μ—μ„ service role keyλ΅ νΈμ¶ν•΄μ•Ό ν•¨

### RLS μ •μ±… ν™•μΈ
```sql
SELECT * FROM pg_policies WHERE tablename = 'profiles';
```

## μ¶”κ°€ κΈ°λ¥ μ μ•

- [ ] μΉκµ¬ μ‹μ¤ν… ν…μ΄λΈ”
- [ ] ν€/ν΄λ μ‹μ¤ν…
- [ ] μ—…μ  μ‹μ¤ν…
- [ ] μ•„μ΄ν…/μ¤ν‚¨ μΈλ²¤ν† λ¦¬
- [ ] μ±„ν… λ©”μ‹μ§€ μ €μ¥

Happy coding! π
